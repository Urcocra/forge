---
import Layout from '../layouts/Layout.astro';
import SelectLog from '../components/SelectLog.astro';
import { getRuns, getRunLog } from '../lib/runs';

// 1. Fetch Data
const runs = await getRuns();
const runId = Astro.url.searchParams.get('log') ?? runs[0]?.runId ?? null;
const logContent = runId ? await getRunLog(runId) : '';

// Escape the log content for passing to client-side script
const escapedLog = JSON.stringify(logContent);
---

<Layout title="FORGE Â· Reproduce">
    <div class="mb-8">
        <h1 class="text-3xl font-bold mb-1">One-command Reproduction</h1>
        <p class="text-base-content/60 font-serif italic max-w-3xl">
            Auditability is paramount. Every run is cryptographically locked to its configuration and environment.
        </p>
    </div>

    {/* Selection Control */}
    <div class="card bg-base-100 shadow-sm border border-base-200 mb-8">
        <div class="card-body py-4">
             <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                 <div>
                     <span class="text-xs font-bold uppercase tracking-wider opacity-50 block mb-1">Select Run to Reproduce</span>
                     <SelectLog selectedRunId={runId} runs={runs} />
                 </div>
                 
                 <div class="flex gap-2">
                    <div class="badge badge-neutral gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                        Hash-locked
                    </div>
                    <div class="badge badge-neutral gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        Deterministic
                    </div>
                    <div class="badge badge-neutral gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                        No Human-in-Loop
                    </div>
                 </div>
             </div>
        </div>
    </div>

    {/* Reproduce Interface */}
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        {/* Helper Panel */}
        <div class="lg:col-span-1 space-y-4">
             <div class="card bg-base-100 shadow-sm border border-base-200">
                <div class="card-body p-4">
                    <h3 class="font-bold text-sm uppercase tracking-wider opacity-70 mb-2">Actions</h3>
                    
                    <div class="form-control mb-4">
                        <label class="label cursor-pointer justify-start gap-4">
                            <span class="label-text font-bold">Mock Mode</span> 
                            <input id="mode-toggle" type="checkbox" class="toggle toggle-primary" />
                            <span class="label-text font-bold">Real API</span> 
                        </label>
                         <div class="text-[10px] opacity-60 px-1 flex justify-between items-center">
                            <span id="mode-desc">Mocking all network calls (Fast)</span>
                             <button id="config-btn" class="btn btn-ghost btn-xs text-primary hidden" title="Configure API Key">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.53 1.53 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <button id="reproduce-btn" class="btn btn-primary w-full gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
  <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v3.25a1 1 0 11-2 0V13.003h-.001a1 1 0 010 .002h-.001A7.002 7.002 0 011.009 11.23a1 1 0 01.61-1.276z" clip-rule="evenodd" />
</svg>
                        Reproduce Run
                    </button>
                    
                    <div class="text-xs text-base-content/50 mt-2 text-center">
                        Replaying execution trace from hash-locked artifacts.
                    </div>
                </div>
             </div>

             <div class="card bg-base-100 shadow-sm border border-base-200">
                 <div class="card-body p-4 text-xs space-y-2">
                     <p>
                         <span class="font-bold">Run ID:</span> <span class="font-mono bg-base-200 px-1 rounded">{runId}</span>
                     </p>
                      <p>
                         <span class="font-bold">Status:</span> <span class="text-success">Verified</span>
                     </p>
                 </div>
             </div>
        </div>

        {/* Terminal/Log Output */}
        <div class="lg:col-span-3">
             <div class="mockup-code bg-gray-900 text-gray-200 h-[600px] overflow-y-auto flex flex-col shadow-lg">
                <div class="flex-none sticky top-0 bg-gray-900 z-10 p-4 border-b border-gray-800 flex items-center justify-between">
                     <span class="badge badge-outline">STDOUT / STDERR</span>
                     <span class="text-xs font-mono opacity-50">/usr/bin/forge-runtime</span>
                </div>
                 <pre class="p-4 font-mono text-xs leading-relaxed whitespace-pre-wrap flex-1 min-h-0" id="terminal-content">
                    {/* Content will be injected here */}
                    <span class="opacity-50">Standard output log will appear here...</span>
                 </pre>
                 <div id="terminal-anchor"></div>
             </div>
        </div>
    </div>

    {/* API Key Config Modal */}
    <dialog id="config_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configure Real API Access</h3>
            <p class="py-4 text-sm text-base-content/70">
                To reproduce this run with live LLM endpoints, please provide a valid API key. 
                This key will be stored locally in your browser.
            </p>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">OpenAI / Provider API Key</span>
                </label>
                <input type="password" id="api-key-input" placeholder="sk-..." class="input input-bordered w-full font-mono" />
            </div>
            <div class="modal-action">
                <form method="dialog">
                     <button class="btn btn-ghost">Cancel</button>
                     <button id="save-key-btn" class="btn btn-primary">Save Key</button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

</Layout>

<script define:vars={{ escapedLog, runId }}>
    const btn = document.getElementById('reproduce-btn');
    const terminal = document.getElementById('terminal-content');
    const toggle = document.getElementById('mode-toggle');
    const modeDesc = document.getElementById('mode-desc');
    const configBtn = document.getElementById('config-btn');
    const configModal = document.getElementById('config_modal');
    const saveKeyBtn = document.getElementById('save-key-btn');
    const apiKeyInput = document.getElementById('api-key-input');
    
    const fullLog = JSON.parse(escapedLog);
    const KEY_STORAGE = 'forge_api_key';

    // Initial State: Show full log
    terminal.textContent = fullLog;
    terminal.scrollTop = terminal.scrollHeight; // Scroll to bottom initially

    // Load existing key
    const savedKey = localStorage.getItem(KEY_STORAGE);
    if (savedKey && apiKeyInput) {
        apiKeyInput.value = savedKey;
    }

    // Toggle Handler
    toggle?.addEventListener('change', (e) => {
        const isReal = e.target.checked;
        if (modeDesc) {
            modeDesc.textContent = isReal
                ? "Connecting to Live LLM endpoints (Slow)" 
                : "Mocking all network calls (Fast)";
        }
        
        if (configBtn) {
            if (isReal) {
                configBtn.classList.remove('hidden');
                // Auto-open if no key
                if (!localStorage.getItem(KEY_STORAGE)) {
                    configModal?.showModal();
                }
            } else {
                configBtn.classList.add('hidden');
            }
        }
    });

    // Config Button Handler
    configBtn?.addEventListener('click', () => {
        configModal?.showModal();
    });

    // Save Key Handler
    saveKeyBtn?.addEventListener('click', () => {
        if (apiKeyInput && apiKeyInput.value.trim()) {
            localStorage.setItem(KEY_STORAGE, apiKeyInput.value.trim());
        }
    });

    // --- EXECUTION LOGIC ---
    
    btn?.addEventListener('click', async () => {
        if (btn.disabled) return;
        const isReal = toggle?.checked;

        // Check for API key if in Real mode
        let apiKey = '';
        if (isReal) {
            apiKey = localStorage.getItem(KEY_STORAGE) || '';
            if (!apiKey) {
                configModal?.showModal();
                return;
            }
        }
        
        // Setup UI
        btn.disabled = true;
        const checkoutText = btn.innerHTML;
        btn.innerHTML = `<span class="loading loading-spinner loading-sm"></span> ${isReal ? 'Running Benchmark...' : 'Replaying...'}`;
        terminal.innerHTML = ''; // Clear terminal

        // --- REAL API KICKOFF ---
        if (isReal) {
            try {
                const response = await fetch('/api/reproduce', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ runId, apiKey })
                });

                if (!response.ok || !response.body) {
                    throw new Error(await response.text() || 'Failed to start reproduction');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const span = document.createElement('span');
                    span.textContent = chunk;
                    terminal.appendChild(span);

                    // Auto scroll
                    const container = terminal.parentElement;
                    if (container) container.scrollTop = container.scrollHeight;
                }

                // Success
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> Success`;

            } catch (err) {
                 const span = document.createElement('span');
                 span.className = "text-error font-bold";
                 span.textContent = `\n[ERROR] ${err.message}\n`;
                 terminal.appendChild(span);
                 
                 btn.innerHTML = `Error`;
            } finally {
                 btn.disabled = false;
                 setTimeout(() => { btn.innerHTML = checkoutText; }, 3000);
            }
            return;
        }

        // --- MOCK SIMULATION ---
        const lines = fullLog.split('\n');
        let i = 0;
        const speed = 5; // Fast
        let accumulator = 0;

        const process = () => {
            if (i >= lines.length) {
                btn.disabled = false;
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> Success`;
                setTimeout(() => { btn.innerHTML = checkoutText; }, 3000);
                return;
            }

            accumulator += speed;
            if (accumulator >= 1) {
                const count = Math.floor(accumulator);
                const chunk = lines.slice(i, i + count).join('\n') + '\n';
                const span = document.createElement('span');
                span.textContent = chunk;
                terminal.appendChild(span);
                const container = terminal.parentElement;
                if(container) container.scrollTop = container.scrollHeight;
                i += count;
                accumulator -= count;
            }
            requestAnimationFrame(process);
        };
        requestAnimationFrame(process);
    });
</script>
